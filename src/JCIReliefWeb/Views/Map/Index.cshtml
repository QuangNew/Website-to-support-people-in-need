@{
    ViewData["Title"] = "B·∫£n ƒë·ªì c·ª©u tr·ª£";
}

<div class="map-page">
    <!-- Map Controls Bar -->
    <div class="map-controls mb-3">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-danger active" data-filter="sos">
                        <i class="fa-solid fa-triangle-exclamation me-1"></i> SOS
                        <span class="badge bg-danger ms-1" id="sosCount">5</span>
                    </button>
                    <button type="button" class="btn btn-outline-success" data-filter="warehouse">
                        <i class="fa-solid fa-warehouse me-1"></i> Kho
                        <span class="badge bg-success ms-1" id="warehouseCount">3</span>
                    </button>
                    <button type="button" class="btn btn-outline-info" data-filter="safe">
                        <i class="fa-solid fa-shield-halved me-1"></i> An to√†n
                        <span class="badge bg-info ms-1" id="safeCount">2</span>
                    </button>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#reportFloodModal">
                    <i class="fa-solid fa-water me-1"></i> B√°o m·ª±c n∆∞·ªõc
                </button>
                <button class="btn btn-primary" id="locateMe">
                    <i class="fa-solid fa-location-crosshairs me-1"></i> V·ªã tr√≠ c·ªßa t√¥i
                </button>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="map-wrapper position-relative">
        <div class="map-container" id="mapContainer">
            <div id="reliefMap"></div>
        </div>
        
        <!-- Map Legend -->
        <div class="map-legend">
            <div class="legend-title">Ch√∫ th√≠ch</div>
            <div class="legend-item">
                <div class="legend-marker sos"></div>
                <span>SOS - C·∫ßn c·ª©u tr·ª£</span>
            </div>
            <div class="legend-item">
                <div class="legend-marker warehouse"></div>
                <span>Kho h√†ng c·ª©u tr·ª£</span>
            </div>
            <div class="legend-item">
                <div class="legend-marker safe"></div>
                <span>ƒêi·ªÉm an to√†n</span>
            </div>
            <div class="legend-item">
                <div class="legend-marker pending"></div>
                <span>ƒêang x·ª≠ l√Ω</span>
            </div>
        </div>

        <!-- Category Filter Panel -->
        <div class="filter-panel">
            <div class="filter-title">
                <i class="fa-solid fa-filter me-2"></i>L·ªçc theo nhu c·∫ßu
            </div>
            <div class="filter-options">
                <label class="filter-option">
                    <input type="checkbox" checked data-category="food">
                    <span class="filter-icon"><i class="fa-solid fa-bowl-rice"></i></span>
                    <span>L∆∞∆°ng th·ª±c</span>
                </label>
                <label class="filter-option">
                    <input type="checkbox" checked data-category="medical">
                    <span class="filter-icon"><i class="fa-solid fa-kit-medical"></i></span>
                    <span>Y t·∫ø</span>
                </label>
                <label class="filter-option">
                    <input type="checkbox" checked data-category="transport">
                    <span class="filter-icon"><i class="fa-solid fa-truck"></i></span>
                    <span>V·∫≠n chuy·ªÉn</span>
                </label>
                <label class="filter-option">
                    <input type="checkbox" checked data-category="shelter">
                    <span class="filter-icon"><i class="fa-solid fa-house"></i></span>
                    <span>Ch·ªó ·ªü</span>
                </label>
            </div>
        </div>
    </div>

    <!-- SOS List Sidebar -->
    <div class="sos-sidebar" id="sosSidebar">
        <div class="sos-sidebar-header">
            <h5><i class="fa-solid fa-list me-2"></i>Danh s√°ch y√™u c·∫ßu</h5>
            <button class="btn btn-sm btn-outline-secondary" id="toggleSidebar">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>
        <div class="sos-list" id="sosList">
            <!-- Dynamic content loaded via JS -->
        </div>
    </div>
</div>

<!-- Report Flood Level Modal -->
<div class="modal fade" id="reportFloodModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fa-solid fa-water me-2"></i>B√°o c√°o m·ª±c n∆∞·ªõc
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">M·ª±c n∆∞·ªõc hi·ªán t·∫°i</label>
                    <select class="form-select" id="floodLevel">
                        <option value="low">Th·∫•p (d∆∞·ªõi 0.5m)</option>
                        <option value="medium">Trung b√¨nh (0.5m - 1m)</option>
                        <option value="high">Cao (1m - 2m)</option>
                        <option value="critical">Nguy hi·ªÉm (tr√™n 2m)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">V·ªã tr√≠</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="reportLocation" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c d√πng GPS">
                        <button class="btn btn-outline-primary" type="button" id="useGPS">
                            <i class="fa-solid fa-location-dot"></i>
                        </button>
                    </div>
                    <div class="form-text" id="gpsCoords"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Ghi ch√∫ th√™m</label>
                    <textarea class="form-control" rows="3" placeholder="M√¥ t·∫£ t√¨nh h√¨nh..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">H√¨nh ·∫£nh (n·∫øu c√≥)</label>
                    <input type="file" class="form-control" accept="image/*">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="submitFloodReport">
                    <i class="fa-solid fa-paper-plane me-1"></i>G·ª≠i b√°o c√°o
                </button>
            </div>
        </div>
    </div>
</div>

@section Styles {
<style>
    .map-page {
        display: flex;
        flex-direction: column;
        height: calc(100vh - var(--header-height) - 48px);
    }

    .map-wrapper {
        flex: 1;
        display: flex;
        position: relative;
    }

    .map-container {
        flex: 1;
        border-radius: 12px;
        overflow: hidden;
    }

    #reliefMap {
        height: 100%;
        width: 100%;
    }

    .filter-panel {
        position: absolute;
        top: 12px;
        right: 12px;
        background: var(--card-bg);
        padding: 16px;
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        z-index: 500;
        min-width: 200px;
    }

    .filter-title {
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text-primary);
    }

    .filter-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        cursor: pointer;
    }

    .filter-option input {
        width: 18px;
        height: 18px;
    }

    .filter-icon {
        width: 32px;
        height: 32px;
        background: var(--bg-color);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
    }

    .sos-sidebar {
        width: 320px;
        background: var(--card-bg);
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease;
    }

    .sos-sidebar.collapsed {
        width: 0;
        overflow: hidden;
    }

    .sos-sidebar-header {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .sos-sidebar-header h5 {
        margin: 0;
        font-size: 1rem;
    }

    .sos-list {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
    }

    .sos-item {
        background: var(--bg-color);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all var(--transition-fast);
        border-left: 4px solid var(--danger-color);
    }

    .sos-item:hover {
        transform: translateX(4px);
        box-shadow: var(--shadow-sm);
    }

    .sos-item.urgent {
        border-left-color: var(--danger-color);
        animation: urgentPulse 2s infinite;
    }

    .sos-item.pending {
        border-left-color: var(--warning-color);
    }

    .sos-item.resolved {
        border-left-color: var(--success-color);
    }

    @@keyframes urgentPulse {
        0%, 100% { background: var(--bg-color); }
        50% { background: rgba(239, 68, 68, 0.1); }
    }

    .sos-item-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 8px;
    }

    .sos-item-title {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-primary);
    }

    .sos-item-category {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 10px;
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary-color);
    }

    .sos-item-address {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 6px;
    }

    .sos-item-time {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    /* Custom Leaflet Popup */
    .leaflet-popup-content-wrapper {
        border-radius: 12px;
        padding: 0;
    }

    .leaflet-popup-content {
        margin: 0;
        min-width: 250px;
    }

    .popup-content {
        padding: 16px;
    }

    .popup-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
    }

    .popup-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .popup-icon.sos { background: #fef2f2; color: var(--danger-color); }
    .popup-icon.warehouse { background: #f0fdf4; color: var(--success-color); }
    .popup-icon.safe { background: #eff6ff; color: var(--info-color); }

    .popup-title {
        font-weight: 600;
        font-size: 1rem;
    }

    .popup-info {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 12px;
    }

    .popup-actions {
        display: flex;
        gap: 8px;
    }

    .popup-actions .btn {
        flex: 1;
        font-size: 0.85rem;
    }
</style>
}

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', async function() {
    // Initialize map centered on Vietnam
    const map = L.map('reliefMap').setView([16.0544, 108.2022], 6);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Load marker data
    const response = await fetch('/data/markers.json');
    const data = await response.json();

    // Custom marker icons using divIcon
    function createMarkerIcon(type, status) {
        const colors = {
            sos: { urgent: '#ef4444', pending: '#f59e0b', resolved: '#22c55e' },
            warehouse: '#22c55e',
            safe: '#06b6d4'
        };

        const icons = {
            sos: 'üö©',
            warehouse: 'üè™',
            safe: '‚úÖ'
        };

        let color = type === 'sos' ? colors.sos[status] : colors[type];
        let blinkClass = status === 'urgent' ? 'urgent' : '';

        return L.divIcon({
            className: 'custom-marker',
            html: `<span class="marker-icon ${blinkClass}" style="color: ${color}; font-size: 28px;">${icons[type]}</span>`,
            iconSize: [30, 30],
            iconAnchor: [15, 30],
            popupAnchor: [0, -30]
        });
    }

    // Add SOS markers
    const markers = {
        sos: [],
        warehouse: [],
        safe: []
    };

    data.sosMarkers.forEach(item => {
        const marker = L.marker([item.lat, item.lng], {
            icon: createMarkerIcon('sos', item.status)
        }).addTo(map);

        marker.bindPopup(`
            <div class="popup-content">
                <div class="popup-header">
                    <div class="popup-icon sos"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <div>
                        <div class="popup-title">${item.title}</div>
                        <span class="status-badge ${item.status}">${item.status === 'urgent' ? 'Kh·∫©n c·∫•p' : item.status === 'pending' ? 'ƒêang x·ª≠ l√Ω' : 'ƒê√£ gi·∫£i quy·∫øt'}</span>
                    </div>
                </div>
                <div class="popup-info">
                    <div><i class="fa-solid fa-location-dot me-2"></i>${item.address}</div>
                    <div><i class="fa-solid fa-water me-2"></i>M·ª±c n∆∞·ªõc: ${item.floodLevel}</div>
                    <div><i class="fa-solid fa-phone me-2"></i>${item.contact}</div>
                </div>
                <div class="popup-actions">
                    <button class="btn btn-sm btn-primary"><i class="fa-solid fa-route me-1"></i>Ch·ªâ ƒë∆∞·ªùng</button>
                    <button class="btn btn-sm btn-success"><i class="fa-solid fa-hand-holding-heart me-1"></i>H·ªó tr·ª£</button>
                </div>
            </div>
        `);

        markers.sos.push(marker);
    });

    // Add warehouse markers
    data.supplyWarehouses.forEach(item => {
        const marker = L.marker([item.lat, item.lng], {
            icon: createMarkerIcon('warehouse')
        }).addTo(map);

        marker.bindPopup(`
            <div class="popup-content">
                <div class="popup-header">
                    <div class="popup-icon warehouse"><i class="fa-solid fa-warehouse"></i></div>
                    <div class="popup-title">${item.name}</div>
                </div>
                <div class="popup-info">
                    <div><i class="fa-solid fa-boxes-stacked me-2"></i>S·ª©c ch·ª©a: ${item.capacity}%</div>
                    <div><i class="fa-solid fa-phone me-2"></i>${item.contact}</div>
                    <div><i class="fa-solid fa-box me-2"></i>${item.supplies.join(', ')}</div>
                </div>
                <div class="popup-actions">
                    <button class="btn btn-sm btn-primary"><i class="fa-solid fa-route me-1"></i>Ch·ªâ ƒë∆∞·ªùng</button>
                </div>
            </div>
        `);

        markers.warehouse.push(marker);
    });

    // Add safe zone markers
    data.safeZones.forEach(item => {
        const marker = L.marker([item.lat, item.lng], {
            icon: createMarkerIcon('safe')
        }).addTo(map);

        marker.bindPopup(`
            <div class="popup-content">
                <div class="popup-header">
                    <div class="popup-icon safe"><i class="fa-solid fa-shield-halved"></i></div>
                    <div class="popup-title">${item.name}</div>
                </div>
                <div class="popup-info">
                    <div><i class="fa-solid fa-users me-2"></i>S·ª©c ch·ª©a: ${item.currentOccupancy}/${item.capacity}</div>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-info" style="width: ${(item.currentOccupancy/item.capacity)*100}%"></div>
                    </div>
                </div>
                <div class="popup-actions">
                    <button class="btn btn-sm btn-primary"><i class="fa-solid fa-route me-1"></i>Ch·ªâ ƒë∆∞·ªùng</button>
                </div>
            </div>
        `);

        markers.safe.push(marker);
    });

    // Update counts
    document.getElementById('sosCount').textContent = markers.sos.length;
    document.getElementById('warehouseCount').textContent = markers.warehouse.length;
    document.getElementById('safeCount').textContent = markers.safe.length;

    // Populate SOS list sidebar
    const sosList = document.getElementById('sosList');
    data.sosMarkers.forEach(item => {
        const categoryLabels = {
            food: 'L∆∞∆°ng th·ª±c',
            medical: 'Y t·∫ø',
            transport: 'V·∫≠n chuy·ªÉn',
            shelter: 'Ch·ªó ·ªü'
        };

        sosList.innerHTML += `
            <div class="sos-item ${item.status}" data-lat="${item.lat}" data-lng="${item.lng}">
                <div class="sos-item-header">
                    <span class="sos-item-title">${item.title}</span>
                    <span class="sos-item-category">${categoryLabels[item.category]}</span>
                </div>
                <div class="sos-item-address">
                    <i class="fa-solid fa-location-dot me-1"></i>${item.address}
                </div>
                <div class="sos-item-time">
                    <i class="fa-regular fa-clock me-1"></i>${JCIRelief.MapUtils.formatRelativeTime(item.timestamp)}
                </div>
            </div>
        `;
    });

    // Click on SOS item to pan to location
    sosList.querySelectorAll('.sos-item').forEach(item => {
        item.addEventListener('click', function() {
            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);
            map.setView([lat, lng], 14);
        });
    });

    // Locate me button
    document.getElementById('locateMe').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                map.setView([lat, lng], 14);
                
                L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<span style="font-size: 24px;">üìç</span>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    })
                }).addTo(map).bindPopup('V·ªã tr√≠ c·ªßa b·∫°n').openPopup();
            });
        }
    });

    // Filter buttons
    document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', function() {
            const filter = this.dataset.filter;
            this.classList.toggle('active');
            
            markers[filter].forEach(marker => {
                if (this.classList.contains('active')) {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
            });
        });
    });

    // GPS for flood report
    document.getElementById('useGPS').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const coords = `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
                document.getElementById('gpsCoords').textContent = `T·ªça ƒë·ªô: ${coords}`;
                document.getElementById('reportLocation').value = 'V·ªã tr√≠ GPS ƒë√£ x√°c ƒë·ªãnh';
            });
        }
    });

    // Submit flood report
    document.getElementById('submitFloodReport').addEventListener('click', function() {
        JCIRelief.FormUtils.showToast('ƒê√£ g·ª≠i b√°o c√°o m·ª±c n∆∞·ªõc th√†nh c√¥ng!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('reportFloodModal')).hide();
    });
});
</script>
}
